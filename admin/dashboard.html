<!doctype html>
<html lang="ar" dir="rtl">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Dashboard — Prok</title>
<link rel="stylesheet" href="../assets/css/style.css"></head>
<body>
<div class="admin-dashboard container" style="padding-top:90px">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>لوحة التحكم</h2>
    <div><span id="userEmail"></span> <button id="logoutBtn" class="btn">تسجيل خروج</button></div>
  </div>

  <section style="margin-top:18px">
    <label>Hero title (AR)</label>
    <input id="hero_ar" />
    <label>Hero title (EN)</label>
    <input id="hero_en" />
    <label>Hero subtitle (AR)</label>
    <textarea id="sub_ar"></textarea>
    <label>Hero subtitle (EN)</label>
    <textarea id="sub_en"></textarea>

    <label>Features (JSON array)</label>
    <textarea id="features" placeholder='مثال: ["ميزة 1","ميزة 2"]'></textarea>

    <div style="margin-top:10px">
      <button id="saveBtn" class="btn">حفظ</button>
      <button id="loadBtn" class="btn" style="background:#888;margin-left:8px">إعادة تحميل</button>
      <div id="status" style="margin-top:8px;color:#9f9"></div>
    </div>
  </section>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../assets/js/firebase-config.js"></script>
<script>
if(!window.firebaseConfig){ alert('Add firebase-config.js'); }
else {
  firebase.initializeApp(window.firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const status = document.getElementById('status');

  auth.onAuthStateChanged(async user=>{
    if(!user) return location.href='index.html';
    document.getElementById('userEmail').textContent = user.email;
    await load();
  });

  document.getElementById('logoutBtn').addEventListener('click', ()=> auth.signOut().then(()=> location.href='index.html'));

  async function load(){
    status.textContent='جاري التحميل...';
    try{
      const doc = await db.collection('site').doc('content').get();
      if(!doc.exists){
        document.getElementById('hero_ar').value='مرحبا';
        document.getElementById('hero_en').value='Welcome';
        document.getElementById('sub_ar').value='';
        document.getElementById('sub_en').value='';
        document.getElementById('features').value = JSON.stringify([], null, 2);
        status.textContent='لا يوجد محتوى بعد (افتراضي)';
        return;
      }
      const data = doc.data();
      document.getElementById('hero_ar').value = data.heroTitle_ar || '';
      document.getElementById('hero_en').value = data.heroTitle || '';
      document.getElementById('sub_ar').value = data.heroSub_ar || '';
      document.getElementById('sub_en').value = data.heroSub || '';
      document.getElementById('features').value = JSON.stringify(data.features || [], null, 2);
      status.textContent='تم التحميل';
    }catch(e){ status.textContent='خطأ: '+e.message; }
  }

  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    let parsed = [];
    try{ parsed = JSON.parse(document.getElementById('features').value || '[]'); if(!Array.isArray(parsed)) throw new Error('Features must be array'); }
    catch(e){ status.textContent='JSON Error: '+e.message; return; }
    status.textContent='جاري الحفظ...';
    try{
      await db.collection('site').doc('content').set({
        heroTitle: document.getElementById('hero_en').value,
        heroTitle_ar: document.getElementById('hero_ar').value,
        heroSub: document.getElementById('sub_en').value,
        heroSub_ar: document.getElementById('sub_ar').value,
        features: parsed,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      status.textContent='تم الحفظ ✅';
    }catch(e){ status.textContent='حفظ خطأ: '+e.message; }
  });
}
</script>
