import time
import random
import json
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import TimeoutException, NoSuchElementException
import requests
from bs4 import BeautifulSoup
import re

class AutoReviewMaster:
    def __init__(self):
        self.setup_driver()
        self.reviews_data = []
        self.arabic_names = self.load_arabic_names()
        self.reviews_db = self.load_reviews_database()
        
    def setup_driver(self):
        """إعداد متصفح Chrome مخفي"""
        print("🔄 جاري إعداد المتصفح...")
        chrome_options = Options()
        chrome_options.add_argument("--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36")
        chrome_options.add_argument("--disable-blink-features=AutomationControlled")
        chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
        chrome_options.add_experimental_option('useAutomationExtension', False)
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        
        self.driver = webdriver.Chrome(options=chrome_options)
        self.driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
        self.wait = WebDriverWait(self.driver, 15)
        print("✅ تم إعداد المتصفح بنجاح")
    
    def load_arabic_names(self):
        """قائمة بأسماء عربية حقيقية"""
        return [
            "محمد أحمد", "أحمد خالد", "خالد إبراهيم", "إبراهيم حسن", "حسن محمود",
            "محمود علي", "علي عمر", "عمر ناصر", "ناصر سعيد", "سعيد راشد",
            "فاطمة محمد", "سارة أحمد", "نورة خالد", "لمى إبراهيم", "هدى حسن",
            "أميرة محمود", "ريم علي", "لينا عمر", "ياسمين ناصر", "عبير سعيد"
        ]
    
    def load_reviews_database(self):
        """قاعدة بيانات التقييمات بالعربية"""
        return {
            "electronics": [
                {"rating": 5, "comment": "جهاز رائع وجودة تصنيعه ممتازة، أنصح به بشدة", "type": "positive"},
                {"rating": 4, "comment": "جيد جداً وسعره معقول، لكن يمكن تحسين بعض الميزات", "type": "mixed"},
                {"rating": 5, "comment": "تجاوز توقعاتي، الأداء سريع والبطارية تدوم طويلاً", "type": "positive"},
                {"rating": 4, "comment": "منتج عملي ويناسب احتياجاتي اليومية، شكراً للجودة", "type": "positive"},
                {"rating": 3, "comment": "مقبول ولكن هناك بعض المشاكل الصغيرة في البرنامج", "type": "constructive"}
            ],
            "clothing": [
                {"rating": 5, "comment": "القماش ممتاز والتفصيل متقن، يناسب المقاس تماماً", "type": "positive"},
                {"rating": 4, "comment": "جيد جداً ولكن الألوان تختلف قليلاً عن الصورة", "type": "mixed"},
                {"rating": 5, "comment": "أنيق ومريح، الجودة أعلى من التوقعات", "type": "positive"},
                {"rating": 4, "comment": "مناسب للسعر، ولكن يمكن تحسين خامة القماش", "type": "constructive"},
                {"rating": 5, "comment": "شكراً للتوصيل السريع، المنتج رائع وأنصح الجميع به", "type": "positive"}
            ],
            "home": [
                {"rating": 5, "comment": "منتج منزلي عملي وجودة التصنيع عالية", "type": "positive"},
                {"rating": 4, "comment": "مفيد في الحياة اليومية، لكن يمكن إضافة ميزات أكثر", "type": "constructive"},
                {"rating": 5, "comment": "تصميم أنيق وملائم للمنازل العصرية", "type": "positive"},
                {"rating": 4, "comment": "جيد ولكن السعر مرتفع قليلاً مقارنة بالجودة", "type": "mixed"},
                {"rating": 5, "comment": "منتج ممتاز ويوفر وقت وجهد كبير في الأعمال المنزلية", "type": "positive"}
            ],
            "books": [
                {"rating": 5, "comment": "كتاب رائع والمحتوى مفيد جداً، أنصح بقراءته", "type": "positive"},
                {"rating": 4, "comment": "معلومات قيمة ولكن يمكن تحسين تنظيم المحتوى", "type": "constructive"},
                {"rating": 5, "comment": "أسلوب شيق ومعلومات دقيقة، تجربة قراءة ممتعة", "type": "positive"},
                {"rating": 4, "comment": "جيد للمبتدئين ولكن يحتاج لإضافة أمثلة أكثر", "type": "mixed"},
                {"rating": 5, "comment": "من أفضل الكتب التي قرأتها في هذا المجال", "type": "positive"}
            ],
            "general": [
                {"rating": 5, "comment": "منتج ممتاز وجودة عالية، أنصح به بشدة", "type": "positive"},
                {"rating": 4, "comment": "جيد جداً وسعره معقول، يناسب الاحتياجات الأساسية", "type": "mixed"},
                {"rating": 5, "comment": "تجاوز توقعاتي، التوصيل سريع والمنتج ممتاز", "type": "positive"},
                {"rating": 4, "comment": "منتج عملي ولكن يمكن تطويره أكثر", "type": "constructive"},
                {"rating": 3, "comment": "مقبول ولكن هناك مجال للتحسين في الجودة", "type": "constructive"}
            ]
        }
    
    def generate_user_data(self):
        """إنشاء بيانات مستخدم عشوائية"""
        name = random.choice(self.arabic_names)
        username = f"{name.split()[0].lower()}{random.randint(100, 999)}"
        email = f"{username}@gmail.com"
        password = f"Pass{random.randint(1000, 9999)}"
        
        return {
            "name": name,
            "username": username,
            "email": email,
            "password": password
        }
    
    def detect_website_type(self, url):
        """كشف نوع الموقع تلقائياً"""
        try:
            self.driver.get(url)
            time.sleep(3)
            
            page_source = self.driver.page_source.lower()
            
            if any(word in page_source for word in ['electronic', 'laptop', 'phone', 'tablet']):
                return "electronics"
            elif any(word in page_source for word in ['clothing', 'fashion', 'shirt', 'dress']):
                return "clothing"
            elif any(word in page_source for word in ['home', 'furniture', 'decor', 'kitchen']):
                return "home"
            elif any(word in page_source for word in ['book', 'library', 'read', 'author']):
                return "books"
            else:
                return "general"
                
        except Exception as e:
            print(f"⚠️ لم يتمكن من كشف نوع الموقع: {e}")
            return "general"
    
    def find_element_advanced(self, selectors, timeout=10):
        """البحث عن عنصر باستخدام multiple selectors"""
        for selector in selectors:
            try:
                element = WebDriverWait(self.driver, timeout).until(
                    EC.presence_of_element_located((By.CSS_SELECTOR, selector))
                )
                return element
            except:
                continue
        return None
    
    def click_element_advanced(self, selectors, timeout=10):
        """النقر على عنصر باستخدام multiple selectors"""
        for selector in selectors:
            try:
                element = WebDriverWait(self.driver, timeout).until(
                    EC.element_to_be_clickable((By.CSS_SELECTOR, selector))
                )
                element.click()
                return True
            except:
                continue
        return False
    
    def send_keys_advanced(self, selectors, text, timeout=10):
        """إدخال نص في حقل باستخدام multiple selectors"""
        for selector in selectors:
            try:
                element = WebDriverWait(self.driver, timeout).until(
                    EC.presence_of_element_located((By.CSS_SELECTOR, selector))
                )
                element.clear()
                element.send_keys(text)
                return True
            except:
                continue
        return False
    
    def auto_register(self, user_data):
        """إنشاء حساب تلقائي"""
        print(f"👤 جاري إنشاء حساب للمستخدم: {user_data['name']}")
        
        # البحث عن رابط التسجيل
        register_selectors = [
            "a[href*='register']",
            "a[href*='signup']",
            "a[href*='تسجيل']",
            "a[href*='انشاء']",
            ".register",
            ".signup",
            "a:contains('إنشاء حساب')",
            "a:contains('تسجيل جديد')",
            "button:contains('اشتراك')"
        ]
        
        if not self.click_element_advanced(register_selectors):
            print("⚠️ لم يتم العثور على رابط التسجيل، جاري البحث عن نموذج مباشر")
            # قد يكون النموذج في الصفحة الرئيسية
            pass
        
        time.sleep(2)
        
        # حقول التسجيل
        registration_fields = {
            "username": [
                "input[name='username']",
                "input[placeholder*='اسم المستخدم']",
                "#username",
                ".username"
            ],
            "email": [
                "input[name='email']",
                "input[type='email']",
                "input[placeholder*='بريد']",
                "#email",
                ".email"
            ],
            "password": [
                "input[name='password']",
                "input[type='password']",
                "input[placeholder*='كلمة']",
                "#password",
                ".password"
            ],
            "name": [
                "input[name='name']",
                "input[name='fullname']",
                "input[placeholder*='اسم']",
                "#name",
                ".name"
            ]
        }
        
        # ملء الحقول
        for field, selectors in registration_fields.items():
            if field in user_data:
                if not self.send_keys_advanced(selectors, user_data[field]):
                    print(f"⚠️ لم يتم العثور على حقل {field}")
        
        time.sleep(1)
        
        # إرسال النموذج
        submit_selectors = [
            "button[type='submit']",
            "input[type='submit']",
            "button:contains('تسجيل')",
            "button:contains('إنشاء')",
            "button:contains('اشتراك')",
            ".submit",
            ".register-btn"
        ]
        
        if self.click_element_advanced(submit_selectors):
            print("✅ تم إنشاء الحساب بنجاح")
            time.sleep(3)
            return True
        else:
            print("❌ فشل في إنشاء الحساب")
            return False
    
    def auto_login(self, user_data):
        """تسجيل دخول تلقائي"""
        print(f"🔐 جاري تسجيل دخول: {user_data['username']}")
        
        # البحث عن رابط الدخول
        login_selectors = [
            "a[href*='login']",
            "a[href*='signin']",
            "a[href*='دخول']",
            ".login",
            ".signin",
            "a:contains('تسجيل الدخول')"
        ]
        
        self.click_element_advanced(login_selectors)
        time.sleep(2)
        
        # حقول الدخول
        login_fields = {
            "username": [
                "input[name='username']",
                "input[name='email']",
                "input[type='text']",
                "#username",
                "#email",
                ".username",
                ".email"
            ],
            "password": [
                "input[name='password']",
                "input[type='password']",
                "#password",
                ".password"
            ]
        }
        
        # ملء الحقول
        for field, selectors in login_fields.items():
            if field in user_data:
                self.send_keys_advanced(selectors, user_data[field])
        
        time.sleep(1)
        
        # زر الدخول
        login_btn_selectors = [
            "button[type='submit']",
            "input[type='submit']",
            "button:contains('دخول')",
            "button:contains('Login')",
            ".login-btn"
        ]
        
        if self.click_element_advanced(login_btn_selectors):
            print("✅ تم تسجيل الدخول بنجاح")
            time.sleep(3)
            return True
        else:
            print("❌ فشل في تسجيل الدخول")
            return False
    
    def discover_products(self):
        """اكتشاف المنتجات في الموقع تلقائياً"""
        print("🔍 جاري اكتشاف المنتجات...")
        
        products = []
        
        # البحث عن روابط المنتجات
        product_selectors = [
            "a[href*='product']",
            "a[href*='item']",
            ".product-link",
            ".item-link",
            ".card a",
            ".product a",
            "article a",
            "[class*='product'] a"
        ]
        
        # جمع جميع روابط المنتجات
        for selector in product_selectors:
            try:
                elements = self.driver.find_elements(By.CSS_SELECTOR, selector)
                for element in elements:
                    href = element.get_attribute('href')
                    if href and any(keyword in href.lower() for keyword in ['product', 'item', 'p=']):
                        products.append(href)
            except:
                continue
        
        # إزالة التكرارات
        unique_products = list(set(products))
        print(f"✅ تم اكتشاف {len(unique_products)} منتج")
        
        return unique_products[:10]  # إرجاع أول 10 منتجات فقط
    
    def auto_review_product(self, product_url, user_data, website_type):
        """وضع تقييم تلقائي للمنتج"""
        print(f"⭐ جاري تقييم المنتج: {product_url}")
        
        try:
            # الانتقال لصفحة المنتج
            self.driver.get(product_url)
            time.sleep(3)
            
            # اختيار تقييم عشوائي مناسب لنوع الموقع
            review = random.choice(self.reviews_db[website_type])
            
            # البحث عن رابط إضافة التقييم
            review_link_selectors = [
                "a[href*='review']",
                "a[href*='rating']",
                ".add-review",
                ".review-link",
                "button:contains('أضف تقييم')",
                "button:contains('اكتب مراجعة')"
            ]
            
            self.click_element_advanced(review_link_selectors)
            time.sleep(2)
            
            # اختيار التقييم بالنجوم
            rating_selectors = [
                f".star-rating label:nth-child({review['rating']})",
                f".rating input[value='{review['rating']}']",
                f".stars label:nth-of-type({review['rating']})",
                f"[class*='star']:nth-child({review['rating']})"
            ]
            
            self.click_element_advanced(rating_selectors)
            time.sleep(1)
            
            # كتابة التعليق
            comment_selectors = [
                "textarea[name='comment']",
                "textarea[name='review']",
                "textarea[placeholder*='تعليق']",
                "textarea[placeholder*='مراجعة']",
                "#comment",
                "#review",
                ".comment-field",
                ".review-text"
            ]
            
            self.send_keys_advanced(comment_selectors, review['comment'])
            time.sleep(1)
            
            # إرسال التقييم
            submit_review_selectors = [
                "button[type='submit']",
                "input[type='submit']",
                "button:contains('إرسال')",
                "button:contains('نشر')",
                ".submit-review",
                ".post-review"
            ]
            
            if self.click_element_advanced(submit_review_selectors):
                print(f"✅ تم نشر التقييم: {review['comment'][:50]}...")
                
                # حفظ بيانات التقييم
                self.reviews_data.append({
                    "user": user_data,
                    "review": review,
                    "product": product_url,
                    "timestamp": time.strftime("%Y-%m-%d %H:%M:%S")
                })
                
                return True
            else:
                print("❌ فشل في إرسال التقييم")
                return False
                
        except Exception as e:
            print(f"❌ خطأ في تقييم المنتج: {e}")
            return False
    
    def smart_navigation(self):
        """تنقل ذكي في الموقع"""
        print("🧭 جاري التنقل الذكي في الموقع...")
        
        # زيارة صفحات عشوائية لمحاكاة المستخدم الحقيقي
        pages_to_visit = random.randint(2, 5)
        
        for i in range(pages_to_visit):
            try:
                # اختيار رابط عشوائي للنقر
                links = self.driver.find_elements(By.TAG_NAME, "a")
                if links:
                    random_link = random.choice(links)
                    if random_link.is_displayed():
                        random_link.click()
                        time.sleep(random.randint(2, 4))
            except:
                pass
    
    def auto_logout(self):
        """تسجيل خروج تلقائي"""
        print("🚪 جاري تسجيل الخروج...")
        
        logout_selectors = [
            "a[href*='logout']",
            "a[href*='signout']",
            "a:contains('خروج')",
            "a:contains('تسجيل خروج')",
            ".logout",
            ".signout"
        ]
        
        self.click_element_advanced(logout_selectors)
        time.sleep(2)
    
    def run_auto_campaign(self, website_url, num_reviews=5):
        """تشغيل الحملة التلقائية الكاملة"""
        print(f"🚀 بدء الحملة التلقائية لموقع: {website_url}")
        print(f"🎯 عدد التقييمات المطلوبة: {num_reviews}")
        
        # كشف نوع الموقع
        website_type = self.detect_website_type(website_url)
        print(f"🏷️ نوع الموقع المكتشف: {website_type}")
        
        # اكتشاف المنتجات
        products = self.discover_products()
        
        if not products:
            print("❌ لم يتم العثور على منتجات، جاري البحث يدوياً...")
            # البحث في صفحات أخرى
            self.driver.get(website_url)
            time.sleep(2)
            products = self.discover_products()
        
        if not products:
            print("❌ فشل في العثور على أي منتجات")
            return
        
        success_count = 0
        
        for i in range(num_reviews):
            print(f"\n{'='*50}")
            print(f"📊 جولة التقييم {i+1} من {num_reviews}")
            print(f"{'='*50}")
            
            try:
                # إنشاء بيانات مستخدم جديدة
                user_data = self.generate_user_data()
                
                # الانتقال للصفحة الرئيسية
                self.driver.get(website_url)
                time.sleep(2)
                
                # محاولة إنشاء حساب
                if not self.auto_register(user_data):
                    # إذا فشل التسجيل، حاول الدخول
                    if not self.auto_login(user_data):
                        print("❌ فشل في التسجيل والدخول، تخطي هذا المستخدم")
                        continue
                
                # تنقل ذكي في الموقع
                self.smart_navigation()
                
                # اختيار منتج عشوائي
                product_url = random.choice(products)
                
                # وضع التقييم
                if self.auto_review_product(product_url, user_data, website_type):
                    success_count += 1
                    print(f"✅ نجح التقييم {success_count} من {num_reviews}")
                
                # تسجيل الخروج
                self.auto_logout()
                
                # تأخير عشوائي بين المستخدمين
                delay = random.randint(10, 20)
                print(f"⏳ انتظار {delay} ثانية قبل المستخدم التالي...")
                time.sleep(delay)
                
            except Exception as e:
                print(f"❌ خطأ في الجولة {i+1}: {e}")
                continue
        
        # إنشاء التقرير النهائي
        self.generate_final_report(success_count, num_reviews)
        
        print(f"\n🎉 اكتملت الحملة! النجاح: {success_count}/{num_reviews}")
    
    def generate_final_report(self, success_count, total_reviews):
        """إنشاء تقرير نهائي مفصل"""
        report = {
            "campaign_summary": {
                "total_reviews_attempted": total_reviews,
                "successful_reviews": success_count,
                "success_rate": f"{(success_count/total_reviews)*100:.1f}%",
                "completion_time": time.strftime("%Y-%m-%d %H:%M:%S")
            },
            "reviews_details": self.reviews_data,
            "statistics": {
                "average_rating": sum(r['review']['rating'] for r in self.reviews_data) / len(self.reviews_data) if self.reviews_data else 0,
                "positive_reviews": len([r for r in self.reviews_data if r['review']['rating'] >= 4]),
                "constructive_reviews": len([r for r in self.reviews_data if r['review']['type'] == 'constructive'])
            }
        }
        
        # حفظ التقرير في ملف
        with open('auto_review_campaign_report.json', 'w', encoding='utf-8') as f:
            json.dump(report, f, ensure_ascii=False, indent=2)
        
        print("📊 تم حفظ التقرير المفصل في: auto_review_campaign_report.json")
        
        # عرض ملخص سريع
        print(f"\n📈 ملخص الحملة:")
        print(f"   • التقييمات الناجحة: {success_count}/{total_reviews}")
        print(f"   • معدل النجاح: {(success_count/total_reviews)*100:.1f}%")
        print(f"   • متوسط التقييم: {report['statistics']['average_rating']:.1f} ⭐")
        print(f"   • التقييمات الإيجابية: {report['statistics']['positive_reviews']}")
    
    def close(self):
        """إغلاق المتصفح"""
        self.driver.quit()
        print("🔚 تم إغلاق المتصفح")

# التشغيل التلقائي الكامل
if __name__ == "__main__":
    print("""
    🚀 نظام التقييمات التلقائي المتكامل
    ⚡ الإصدار: 2.0 - كامل الآلية
    📧 المطور: نظام الذكاء الاصطناعي
    """)
    
    # إعدادات تلقائية
    WEBSITE_URL = "https://example.com"  # ضع رابط موقعك هنا
    NUM_REVIEWS = 5  # عدد التقييمات المطلوبة
    
    bot = AutoReviewMaster()
    
    try:
        # تشغيل الحملة التلقائية الكاملة
        bot.run_auto_campaign(WEBSITE_URL, NUM_REVIEWS)
        
    except KeyboardInterrupt:
        print("\n⏹️ تم إيقاف البرنامج بواسطة المستخدم")
    except Exception as e:
        print(f"\n💥 خطأ غير متوقع: {e}")
    finally:
        bot.close()
