(async function(){ if(!window.firebase){ alert('أضف firebase-config.js'); return; } const auth=firebase.auth(); const db=firebase.firestore(); const storage=firebase.storage(); auth.onAuthStateChanged(async user=>{ if(!user){ window.location.href='login.html'; return;} document.getElementById('adminEmail').textContent=user.email; await load(); }); async function load(){ try{ const doc=await db.collection('site').doc('content').get(); const data=doc.exists?doc.data():{apps:[],banners:[]}; renderApps(data.apps||[]); renderBanners(data.banners||[]); }catch(e){console.error(e); renderApps([]); renderBanners([]);} } function renderApps(apps){ const el=document.getElementById('appsEditor'); el.innerHTML=''; apps.forEach((a,idx)=>{ const node=document.createElement('div'); node.innerHTML=`<input class="t" value="${a.title||''}"> <input class="d" value="${a.desc||''}"> <button class="del" data-idx="${idx}">حذف</button>`; el.appendChild(node); }); } function renderBanners(banners){ const el=document.getElementById('bannersList'); el.innerHTML=''; (banners||[]).forEach(b=>{ const n=document.createElement('div'); n.style.marginBottom='8px'; n.innerHTML=`<img src="${b.imageUrl}" style="width:120px;height:60px;object-fit:cover;border-radius:6px"> <button class="delb" data-url="${b.imageUrl}">حذف</button>`; el.appendChild(n); }); } document.getElementById('uploadBtn').addEventListener('click', async ()=>{ const file=document.getElementById('uploadInput').files[0]; if(!file) return alert('اختر صورة'); const ref=storage.ref('banners/'+Date.now()+'_'+file.name); const snap=await ref.put(file); const url=await snap.ref.getDownloadURL(); const doc=await db.collection('site').doc('content').get(); const data=doc.exists?doc.data():{apps:[],banners:[]}; data.banners=data.banners||[]; data.banners.unshift({imageUrl:url,title:file.name}); await db.collection('site').doc('content').set(data,{merge:true}); alert('تم الرفع وحفظه'); load(); }); document.getElementById('addApp').addEventListener('click', async ()=>{ const t=document.getElementById('newTitle').value.trim(); const d=document.getElementById('newDesc').value.trim(); if(!t) return alert('ضع اسم للتطبيق'); const doc=await db.collection('site').doc('content').get(); const data=doc.exists?doc.data():{apps:[],banners:[]}; data.apps=data.apps||[]; data.apps.unshift({title:t,desc:d}); await db.collection('site').doc('content').set(data,{merge:true}); document.getElementById('newTitle').value=''; document.getElementById('newDesc').value=''; alert('تم الإضافة'); load(); }); document.getElementById('saveAll').addEventListener('click',()=> alert('التغييرات محفوظة في Firestore')); document.getElementById('signOut').addEventListener('click', async ()=>{ await auth.signOut(); window.location.href='login.html'; }); })();